<!-- _includes/menu (no highlight/active logic) -->
<div class="nav-band">
  <div class="menu" role="navigation" aria-label="Site">

    <details class="menu-collapsible" data-autotoggle>
      <summary class="menu-summary" aria-label="Open main menu">Menu</summary>

      <nav class="menu-content" aria-label="Main">
        {% for item in site.data.settings.menu %}
          {% assign path = item.path | default: '' %}
          {% capture base_href %}{% if path != '' %}/{{ path }}{% endif %}{% endcapture %}

          {% if item.submenu %}
            <div class="dropdown">

              {% if item.url %}
                {%- comment -%} Parent with its own landing page {%- endcomment -%}
                {% capture href_raw %}{{ base_href }}/{{ item.url }}{% endcapture %}
                <a class="menu-link parent-link has-sub"
                   href="{{ href_raw | relative_url }}">
                  {{ item.name }} <span class="caret" aria-hidden="true">▾</span>
                </a>

              {% else %}
                {%- comment -%} Parent with NO landing page {%- endcomment -%}
                <span class="menu-link has-sub" tabindex="0">
                  {{ item.name }} <span class="caret" aria-hidden="true">▾</span>
                </span>
              {% endif %}

              <div class="dropdown-content" role="menu">
                {% for subitem in item.submenu %}
                  {% assign subpath = subitem.path | default: path %}
                  {% capture subhref_raw %}{% if subpath != '' %}/{{ subpath }}{% endif %}/{{ subitem.url }}{% endcapture %}
                  <a role="menuitem" href="{{ subhref_raw | relative_url }}">
                    {{ subitem.name }}
                  </a>
                {% endfor %}
              </div>
            </div>

          {% else %}
            {% if item.url %}
              {% capture href_raw %}{{ base_href }}/{{ item.url }}{% endcapture %}
              <a class="menu-link" href="{{ href_raw | relative_url }}">
                {{ item.name }}
              </a>
            {% endif %}
          {% endif %}
        {% endfor %}
      </nav>
    </details>

    <!-- Social icons -->
    <nav class="social-icons" aria-label="Social">
      {% for item in site.data.settings.social %}
        <a href="{{ item.link }}" target="_blank" rel="noopener">
          <i class="fa fa-{{ item.icon }}" aria-hidden="false"></i>
          <span class="sr-only">{{ item.icon }}</span>
        </a>
      {% endfor %}
    </nav>

  </div>
</div>

<script>
(function () {
  var d = document.querySelector('.menu-collapsible');
  if (!d) return;
  var mq = window.matchMedia('(min-width: 761px)');
  function apply(){ d.open = mq.matches; }
  apply();
  (mq.addEventListener ? mq.addEventListener('change', apply) : mq.addListener(apply));

  // Close mobile menu after selecting a link
  document.addEventListener('click', function (e) {
    if (e.target.closest('.menu-content a') && window.matchMedia('(max-width: 760px)').matches) {
      d.open = false;
    }
  });
})();
</script>
<script>
(function () {
  const isDesktop = () => window.matchMedia('(min-width: 761px)').matches &&
                         window.matchMedia('(hover:hover) and (pointer:fine)').matches;

  function measureShown(el){
    // Temporarily show the panel to measure if it's hidden
    const prevVis = el.style.visibility;
    const prevDisp = el.style.display;
    el.style.visibility = 'hidden';
    el.style.display = 'block';
    const rect = el.getBoundingClientRect();
    el.style.display = prevDisp || '';
    el.style.visibility = prevVis || '';
    return rect;
  }

  function positionPanel(drop){
    const panel = drop.querySelector('.dropdown-content');
    if (!panel || !isDesktop()) return;

    // Reset alignment before measuring
    drop.classList.remove('align-right');
    panel.style.right = ''; panel.style.left = '';

    // Measure (works even if hidden)
    const rect = measureShown(panel);
    const pad = 12; // margin from viewport edge

    const overflowRight = rect.right > (window.innerWidth - pad);
    const overflowLeft  = rect.left  < pad;

    if (overflowRight) {
      drop.classList.add('align-right');        // CSS pins to right
    } else if (overflowLeft) {
      drop.classList.remove('align-right');     // keep left
      panel.style.left = pad + 'px';            // nudge inside viewport
    }

    // Vertical safety: if panel would go off the bottom, cap height & scroll
    const maxH = Math.min(window.innerHeight * 0.7, 520);
    if (rect.height > maxH) {
      panel.style.maxHeight = maxH + 'px';
      panel.style.overflow = 'auto';
    } else {
      panel.style.maxHeight = '';
      panel.style.overflow = '';
    }
  }

  const DROPS = document.querySelectorAll('.nav-band .dropdown');

  // Reposition right before it opens (hover/focus)
  DROPS.forEach(dd => {
    dd.addEventListener('mouseenter', () => positionPanel(dd));
    dd.addEventListener('focusin',    () => positionPanel(dd));
  });

  // Re-check on resize/orientation change
  window.addEventListener('resize', () => DROPS.forEach(positionPanel));
})();
</script>
